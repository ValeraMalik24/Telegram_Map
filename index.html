<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet CSS (–±–µ–∑ integrity) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- –í–∞—à–∏ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ style.css, –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞ */
    html, body { margin:0; padding:0; }
    #map { height:100vh; width:100vw; }
    .menu {
      position:absolute; bottom:10px; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,.95);
      padding:8px 12px;
      border-radius:8px;
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:min-content;
      gap:12px;
      max-width:640px;
      overflow-x:auto;
      scrollbar-width:none;
      box-shadow:0 0 6px rgba(0,0,0,.25);
      z-index:1000;
    }
    .menu::-webkit-scrollbar { display:none; }
    .menu::after {
      content:'';
      position:absolute;
      top:0; right:0;
      width:32px; height:100%;
      pointer-events:none;
      background:linear-gradient(to right, rgba(255,255,255,0), rgba(0,0,0,.15));
    }
    .menu-item { text-align:center; font:12px/1 sans-serif; }
    .menu-item button {
      background:none; border:2px solid transparent;
      border-radius:6px; padding:2px; margin-bottom:4px;
      cursor:pointer;
    }
    .menu-item.selected button {
      border-color:#007bff; box-shadow:0 0 4px #007bff;
    }
    .menu-item img {
      width:36px; height:36px; border-radius:4px;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="menu" class="menu">
    <div class="menu-item" data-type="shahed">
      <button><img src="shahed.png" alt="Shahed"></button><span>Shahed</span>
    </div>
    <div class="menu-item" data-type="shaheds">
      <button><img src="Shaheds.png" alt="Shaheds"></button><span>Shaheds</span>
    </div>
    <div class="menu-item" data-type="orlan">
      <button><img src="orlan.png" alt="Orlan"></button><span>Orlan</span>
    </div>
    <div class="menu-item" data-type="zala">
      <button><img src="zala.png" alt="Zala"></button><span>Zala</span>
    </div>
    <div class="menu-item" data-type="molniya">
      <button><img src="molniya.png" alt="Molniya"></button><span>Molniya</span>
    </div>
    <div class="menu-item" data-type="lancet">
      <button><img src="lancet.png" alt="Lancet"></button><span>Lancet</span>
    </div>
    <div class="menu-item" data-type="supercam">
      <button><img src="supercam.png" alt="Supercam"></button><span>Supercam</span>
    </div>
    <div class="menu-item" data-type="kab">
      <button><img src="Kab.png" alt="–ö–ê–ë"></button><span>–ö–ê–ë</span>
    </div>
    <div class="menu-item" data-type="rocket">
      <button><img src="Rocket.png" alt="–†–∞–∫–µ—Ç–∞"></button><span>–†–∞–∫–µ—Ç–∞</span>
    </div>
    <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π">
      <button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png" alt="–ù–µ–≤—ñ–¥–æ–º–∏–π"></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span>
    </div>
  </div>

  <!-- Leaflet JS (–±–µ–∑ integrity) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- rotatedMarker plugin -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
      const map = L.map('map').setView([49.9, 36.3], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // 2. –ò–∫–æ–Ω–∫–∏
      function ic(url, size) {
        return L.icon({
          iconUrl: url,
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        });
      }
      const icons = {
        shahed:   ic('shahed.png', 36),
        shaheds:  ic('Shaheds.png', 72),
        orlan:    ic('orlan.png', 36),
        zala:     ic('zala.png', 36),
        molniya:  ic('molniya.png', 36),
        lancet:   ic('lancet.png', 36),
        supercam: ic('supercam.png', 36),
        kab:      ic('Kab.png', 72),
        rocket:   ic('Rocket.png', 72),
        "–Ω–µ–≤—ñ–¥–æ–º–∏–π": ic('–Ω–µ–≤—ñ–¥–æ–º–∏–π.png', 36)
      };
      const arrowIcon = ic('arrow.png', 24);
      const rotOff = { kab: 135, "–Ω–µ–≤—ñ–¥–æ–º–∏–π": 0, default: 45 };

      // 3. –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞
      const menu = document.getElementById('menu');
      let selected = null;
      menu.addEventListener('click', e => {
        const it = e.target.closest('.menu-item');
        if (!it) return;
        menu.querySelectorAll('.menu-item').forEach(x => x.classList.remove('selected'));
        it.classList.add('selected');
        selected = it.dataset.type;
      });
      menu.addEventListener('wheel', e => {
        if (e.deltaY) {
          e.preventDefault();
          menu.scrollLeft += e.deltaY;
        }
      });

      // 4. –ì–µ–æ-—É—Ç–∏–ª–∏—Ç—ã
      function bearing(a, b) {
        const œÜ1 = a.lat * Math.PI/180;
        const œÜ2 = b.lat * Math.PI/180;
        const Œª1 = a.lng * Math.PI/180;
        const Œª2 = b.lng * Math.PI/180;
        const y = Math.sin(Œª2-Œª1) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1)*Math.sin(œÜ2)
                - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
        return (Math.atan2(y, x) * 180/Math.PI + 360) % 360;
      }

      // 5. –ê–Ω–∏–º–∞—Ü–∏—è
      const drones = [];
      const LOOP_MS = 6000;
      function startLoop(dr) {
        cancelAnimationFrame(dr._anim);
        if (!dr.loopFrom || !dr.loopTo) return;
        const step = ts => {
          if (dr.dragBusy) {
            dr._anim = requestAnimationFrame(step);
            return;
          }
          const phase = (ts % LOOP_MS) / LOOP_MS;
          const p = 0.5 - 0.5 * Math.cos(2 * Math.PI * phase);
          const lat = dr.loopFrom.lat + (dr.loopTo.lat - dr.loopFrom.lat) * p;
          const lng = dr.loopFrom.lng + (dr.loopTo.lng - dr.loopFrom.lng) * p;
          dr.marker.setLatLng([lat, lng]);
          dr._anim = requestAnimationFrame(step);
        };
        dr._anim = requestAnimationFrame(step);
      }

      function setHeading(i, val) {
        const v = parseFloat(val);
        if (isNaN(v)) return;
        const d = drones[i];
        d.marker.setRotationAngle(v - d.rot);
        if (d.arrowHead) d.arrowHead.setRotationAngle(v - 90);
        d.marker.closePopup();
      }

      function del(i) {
        const d = drones[i];
        if (!d) return;
        cancelAnimationFrame(d._anim);
        [d.marker, d.shadow, d.line, d.arrowHead].forEach(layer => {
          if (layer) map.removeLayer(layer);
        });
        drones[i] = null;
      }

      // 6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–ª–∏–∫—É
      map.on('click', e => {
        if (!selected || !(selected in icons)) return;
        const rot = rotOff[selected] ?? rotOff.default;
        const marker = L.marker(e.latlng, {
          icon: icons[selected],
          draggable: true,
          rotationOrigin: 'center'
        }).addTo(map);

        const shadow = L.polyline([], { color:'#fff', weight:8, opacity:0.6 }).addTo(map);
        const line   = L.polyline([], { color:'#000', weight:4 }).addTo(map);

        const idx = drones.length;
        const dr = {
          marker,
          shadow,
          line,
          arrowHead: null,
          rot,
          loopFrom: null,
          loopTo: null,
          _anim: 0,
          dragBusy: false
        };
        drones.push(dr);

        let startPos;
        marker.on('dragstart', () => {
          dr.dragBusy = true;
          startPos = marker.getLatLng();
        });
        marker.on('dragend', () => {
          dr.dragBusy = false;
          const endPos = marker.getLatLng();
          dr.loopFrom = startPos;
          dr.loopTo   = endPos;
          shadow.setLatLngs([startPos, endPos]);
          line.setLatLngs([startPos, endPos]);
          if (dr.arrowHead) map.removeLayer(dr.arrowHead);
          dr.arrowHead = L.rotatedMarker(startPos, {
            icon: arrowIcon,
            rotationAngle: bearing(startPos, endPos) - 90
          }).addTo(map);
          startLoop(dr);
        });

        marker.bindPopup(`
          <b>${selected.toUpperCase()}</b><br>
          –ö—É—Ä—Å:
          <input id="h_${idx}" type="number" min="0" max="359" value="0" style="width:60px">
          <button onclick="setHeading(${idx}, document.getElementById('h_${idx}').value)">OK</button><br>
          <button onclick="del(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        `).openPopup();
      });

    }); // –∫–æ–Ω–µ—Ü DOMContentLoaded
  </script>

</body>
</html>
