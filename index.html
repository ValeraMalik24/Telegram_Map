<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet core : –±–µ–∑ SRI, —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞–ª–æ —á–µ—Ä–µ–∑ checksum -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Plugins (cors‚Äëfriendly —à–ª—è—Ö–∏) -->
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js" crossorigin=""></script>
  <!-- polylineDecorator.min.js –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É –ø–∞–∫–µ—Ç—ñ, —î —Ç—ñ–ª—å–∫–∏ .js -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.js" crossorigin=""></script>

  <style>
    html,body{margin:0;padding:0}
    #map{width:100vw;height:100vh}
    .menu{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;display:grid;
      grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;max-width:640px;overflow-x:auto;
      scrollbar-width:none;box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;margin-bottom:4px;cursor:pointer}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="menu" class="menu"></div>

<script>
/***********************  CONFIG  *********************************/
const TYPES=[['shahed',36],['shaheds',72],['orlan',36],['zala',36],['molniya',36],['lancet',36],['supercam',36],['kab',72],['rocket',72],['–Ω–µ–≤—ñ–¥–æ–º–∏–π',36]];
const ROT_OFFSET={kab:135,'–Ω–µ–≤—ñ–¥–æ–º–∏–π':0,default:45};
const ANIM_MS=6000;           // —Ü–∏–∫–ª —Ä—É—Ö—É (–º—Å)
const SMALL_ARROW=8;          // –¥–µ–∫–æ—Ä-—Å—Ç—Ä—ñ–ª–∫–∞ (px)
const REPEAT='10%';           // –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω—ñ—Å—Ç—å –¥–µ–∫–æ—Ä—É
const PROJ_DIST=3000;         // –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ–≤–∂–∏–Ω–æ—é 3¬†–∫–º
/******************************************************************/

let map=null;
const drones=[];
let selectedType=null;
let activeIdx=null;

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeIcon(name,size){return L.icon({iconUrl:`${name}.png`,iconSize:[size,size],iconAnchor:[size/2,size/2]});}
function bearing(a,b){const œÜ1=a.lat*Math.PI/180,œÜ2=b.lat*Math.PI/180,ŒîŒª=(b.lng-a.lng)*Math.PI/180;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);return(Math.atan2(y,x)*180/Math.PI+360)%360;}
function destPoint(pt,brg,dist){const R=6371000,Œ¥=dist/R,Œ∏=brg*Math.PI/180;const œÜ1=pt.lat*Math.PI/180,Œª1=pt.lng*Math.PI/180;const œÜ2=Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥)+Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(Œ∏));const Œª2=Œª1+Math.atan2(Math.sin(Œ∏)*Math.sin(Œ¥)*Math.cos(œÜ1),Math.cos(Œ¥)-Math.sin(œÜ1)*Math.sin(œÜ2));return L.latLng(œÜ2*180/Math.PI,(Œª2*180/Math.PI+540)%360-180);} // –Ω–æ—Ä–º–∞–ª—ñ–∑. –¥–æ–≤–≥–æ—Ç–∏

/********* Popup helpers *********/
window.removeDrone=idx=>{const dr=drones[idx];if(!dr)return;cancelAnimationFrame(dr._raf);cancelAnimationFrame(dr._arrowRAF);[dr.marker,dr.shadow,dr.line,dr.decor,dr.proj].forEach(l=>l && map.removeLayer(l));drones[idx]=null;};
window.setParams=(idx,alt,speed)=>{const dr=drones[idx];if(!dr)return;dr.alt=+alt||0;dr.speed=+speed||0;dr.marker.closePopup();};

/***********************  INIT  ***********************************/
document.addEventListener('DOMContentLoaded',()=>{
  // 1. –∫–∞—Ä—Ç–∞
  map=L.map('map').setView([49.9,36.3],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'¬© OpenStreetMap'}).addTo(map);

  // 2. –º–µ–Ω—é
  const icons={};
  const menu=document.getElementById('menu');
  TYPES.forEach(([name,size])=>{icons[name]=makeIcon(name,size);const el=document.createElement('div');el.className='menu-item';el.dataset.type=name;el.innerHTML=`<button><img src="${name}.png"></button><span>${name}</span>`;menu.appendChild(el);});
  menu.addEventListener('click',e=>{const it=e.target.closest('.menu-item');if(!it)return;menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));it.classList.add('selected');selectedType=it.dataset.type;activeIdx=null;});
  menu.addEventListener('wheel',e=>{if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY;}});

  // 3. –∫–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ
  map.on('click',e=>{
    if(activeIdx!==null){const dr=drones[activeIdx];setCourse(dr,dr.marker.getLatLng(),e.latlng);activeIdx=null;return;}
    if(selectedType){addDrone(e.latlng,selectedType,icons[selectedType]);menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));selectedType=null;}
  });
});

/***********************  addDrone  *******************************/
function addDrone(latlng,type,icon){
  const idx=drones.length;
  const marker=L.marker(latlng,{icon,draggable:true,rotationOrigin:'center'}).addTo(map);
  const shadow=L.polyline([], {color:'#fff',weight:4,opacity:.5,interactive:false}).addTo(map);
  const line  =L.polyline([], {color:'#000',weight:2,interactive:false}).addTo(map);
  const dr={marker,shadow,line,decor:null,proj:null,rotOffset:ROT_OFFSET[type]??ROT_OFFSET.default,path:[latlng],alt:0,speed:0,dragging:false,_raf:0,_arrowRAF:0};
  drones.push(dr);

  marker.on('dragstart',()=>dr.dragging=true);
  marker.on('dragend',()=>{dr.dragging=false;activeIdx=null;});
  marker.on('click',ev=>{activeIdx=idx;ev.originalEvent.stopPropagation();});

  marker.bindPopup(`–í–∏—Å–æ—Ç–∞: <input id='alt_${idx}' type='number' value='${dr.alt}' style='width:50px'>–º<br>–®–≤–∏–¥–∫—ñ—Å—Ç—å: <input id='spd_${idx}' type='number' value='${dr.speed}' style='width:50px'>–∫–º/–≥–æ–¥<br><button onclick="setParams(${idx},document.getElementById('alt_${idx}').value,document.getElementById('spd_${idx}').value)">OK</button><br><button onclick="removeDrone(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>`);
}

/****************   –ö—É—Ä—Å + –ø—Ä–æ–µ–∫—Ü—ñ—è   *****************************/
function setCourse(dr,A,B){
  dr.path=[A,B];
  dr.shadow.setLatLngs(dr.path);
  dr.line.setLatLngs(dr.path);
  const ang=bearing(A,B);
  if(dr.marker.setRotationAngle)dr.marker.setRotationAngle(ang-dr.rotOffset);
  drawArrows(dr);
  drawProjection(dr,B,ang);
  startLoop(dr,A,B);
}
function drawProjection(dr,startPt,ang){if(dr.proj) map.removeLayer(dr.proj);const endPt=destPoint(startPt,ang,PROJ_DIST);dr.proj=L.polyline([startPt,endPt],{color:'#000',weight:1,dashArray:'6 6',interactive:false}).addTo(map);} 

/***********************  decorations  ***************************/
function drawArrows(dr){if(dr.decor) map.removeLayer(dr.decor);dr.decor=L.polylineDecorator(dr.line,{interactive:false,patterns:[{offset:'0%',repeat:REPEAT,symbol:L.Symbol.arrowHead({pixelSize:SMALL_ARROW,polygon:false,pathOptions:{stroke:true,color:'#000',weight:2,interactive:false}})}]}).addTo(map);animateArrows(dr);} 

/***********************  animations  ****************************/
