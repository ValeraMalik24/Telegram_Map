<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- –ü–ª–∞–≥—ñ–Ω –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç—É –º–∞—Ä–∫–µ—Ä—ñ–≤ (–Ω–µ –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ, –∞–ª–µ —è–∫—â–æ —î ‚Äî –∫—Ä–∞—â–µ) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html,body{margin:0;padding:0}  
    #map{width:100vw;height:100vh}

    .menu{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;
      display:grid;grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;
      max-width:640px;overflow-x:auto;scrollbar-width:none;box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;margin-bottom:4px;cursor:pointer}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–µ–Ω—é –ë–ø–õ–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="menu" class="menu"></div>

<script>
/***********************   –ö–û–ù–§–Ü–ì   *********************************/
const TYPES = [
  ['shahed',   36],  ['shaheds', 72], ['orlan',   36], ['zala',    36],
  ['molniya',  36],  ['lancet',  36], ['supercam',36], ['kab',     72],
  ['rocket',   72],  ['–Ω–µ–≤—ñ–¥–æ–º–∏–π',36]
];
// –ù–∞ —Å–∫—ñ–ª—å–∫–∏ —Ç—Ä–µ–±–∞ –ø—ñ–¥–∫—Ä—É—Ç–∏—Ç–∏ —ñ–∫–æ–Ω–∫—É –¥—Ä–æ–Ω–∞, –∞–±–∏ ¬´–Ω—É–ª—å¬ª –¥–∏–≤–∏–≤—Å—è –Ω–∞ –ø—ñ–≤–Ω—ñ—á
const ROT_OFFSET = {kab:135, '–Ω–µ–≤—ñ–¥–æ–º–∏–π':0, default:45};
// –Ø–∫—â–æ —Å—Ç—Ä—ñ–ª–∫–∞ —É png –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å—Ö—ñ–¥ ‚Äî —Å—Ç–∞–≤–∏–º–æ -90; —è–∫—â–æ –Ω–∞ –ø—ñ–≤–Ω—ñ—á ‚Äî 0
const ARROW_FIX = -90;
// –°–∫—ñ–ª—å–∫–∏ —Ç–æ—á–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É —Ç—Ä–∏–º–∞—Ç–∏
const MAX_POINTS = 7;
// –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó (–º—Å) –≤—ñ–¥ A –¥–æ B
const ANIM_MS = 4000;
/********************************************************************/

// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–ª–∞–≥—ñ–Ω –ø–æ–≤–æ—Ä–æ—Ç—É
const hasRotate = typeof L.rotatedMarker === 'function';

// ********   –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω   *******
window.map = null;
window.drones = [];

// ********   –£—Ç–∏–ª—ñ—Ç–∏   ********
function makeIcon(url,size){return L.icon({iconUrl:`${url}.png`,iconSize:[size,size],iconAnchor:[size/2,size/2]});}
function bearing(a,b){const œÜ1=a.lat*Math.PI/180,œÜ2=b.lat*Math.PI/180,ŒîŒª=(b.lng-a.lng)*Math.PI/180;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);return(Math.atan2(y,x)*180/Math.PI+360)%360;}
function mid(a,b){return L.latLng((a.lat+b.lat)/2,(a.lng+b.lng)/2);}    

// ********   –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è popup   ********
window.setHeading = (idx,val)=>{
  const v=parseFloat(val);if(isNaN(v))return;
  const dr=window.drones[idx];if(!dr)return;
  if(dr.marker.setRotationAngle)dr.marker.setRotationAngle(v-(dr.rotOffset||0));
  if(dr.arrow && dr.arrow.setRotationAngle)dr.arrow.setRotationAngle(v+ARROW_FIX);
  dr.marker.closePopup();
};
window.removeDrone = idx=>{
  const dr=window.drones[idx];if(!dr)return;
  cancelAnimationFrame(dr._raf);
  [dr.marker,dr.shadow,dr.line,dr.arrow].forEach(l=>l && map.removeLayer(l));
  window.drones[idx]=null;
};

/*******************   INIT   *******************/
window.addEventListener('DOMContentLoaded',()=>{
  /* 1. –ö–∞—Ä—Ç–∞ */
  map = L.map('map').setView([49.9,36.3],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'¬© OpenStreetMap'}).addTo(map);

  /* 2. –Ü–∫–æ–Ω–∫–∏ —Ç–∞ –º–µ–Ω—é */
  const icons = {};
  const menu  = document.getElementById('menu');
  TYPES.forEach(([name,size])=>{
    icons[name]=makeIcon(name,size);
    const item=document.createElement('div');item.className='menu-item';item.dataset.type=name;
    item.innerHTML=`<button><img src="${name}.png" alt="${name}"></button><span>${name}</span>`;
    menu.appendChild(item);
  });
  let selected=null;
  menu.addEventListener('click',e=>{
    const it=e.target.closest('.menu-item');if(!it)return;
    menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));
    it.classList.add('selected');selected=it.dataset.type;
  });
  menu.addEventListener('wheel',e=>{if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY;}});

  /* 3. –ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ ‚Äì –¥–æ–¥–∞—î–º–æ –¥—Ä–æ–Ω–∞ */
  map.on('click',e=>{
    if(!selected||!(selected in icons))return;
    const idx = window.drones.length;

    const marker=L.marker(e.latlng,{icon:icons[selected],draggable:true,rotationOrigin:'center'}).addTo(map);
    const shadow=L.polyline([],{color:'#fff',weight:4,opacity:.5}).addTo(map);
    const line  =L.polyline([],{color:'#000',weight:2}).addTo(map);

    const dr={marker,shadow,line,arrow:null,rotOffset:ROT_OFFSET[selected]??ROT_OFFSET.default,path:[e.latlng],dragging:false,_raf:0};
    window.drones.push(dr);

    marker.on('dragstart',()=>dr.dragging=true);
    marker.on('dragend',()=>{
      dr.dragging=false;
      dr.path.push(marker.getLatLng()); if(dr.path.length>MAX_POINTS)dr.path.shift();
      shadow.setLatLngs(dr.path);       line.setLatLngs(dr.path);

      const A=dr.path[dr.path.length-2],B=dr.path[dr.path.length-1];
      const ang=bearing(A,B);
      if(marker.setRotationAngle)marker.setRotationAngle(ang-dr.rotOffset);

      if(dr.arrow)map.removeLayer(dr.arrow);
      dr.arrow=(hasRotate?L.rotatedMarker:L.marker)(mid(A,B),{icon:makeIcon('arrow',24),rotationAngle:ang+ARROW_FIX,interactive:false}).addTo(map);

      animateSegment(dr,A,B);
    });

    marker.bindPopup(`<b>${selected.toUpperCase()}</b><br>–ö—É—Ä—Å: <input id="h_${idx}" type="number" min="0" max="359" value="0" style="width:60px"> <button onclick="setHeading(${idx},document.getElementById('h_${idx}').value)">OK</button><br><button onclick="removeDrone(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>`).openPopup();
  });
});

/*******************   –ê–Ω—ñ–º–∞—Ü—ñ—è A‚ÜíB (–æ–¥–∏–Ω —Ä–∞–∑)   *******************/
function animateSegment(dr,A,B){
  cancelAnimationFrame(dr._raf);
  const start=performance.now();
  const step=ts=>{
    const t=Math.min((ts-start)/ANIM_MS,1);
    const lat=A.lat+(B.lat-A.lat)*t,lng=A.lng+(B.lng-A.lng)*t;
    dr.marker.setLatLng([lat,lng]);
    if(t<1)dr._raf=requestAnimationFrame(step);
  };
  dr._raf=requestAnimationFrame(step);
}
</script>
</body>
</html>
