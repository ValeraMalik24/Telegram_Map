<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>SKY KHARKIV MAPüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- –ü–ª–∞–≥—ñ–Ω–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.polylinedecorator/1.7.0/leaflet.polylineDecorator.min.js"></script>

  <style>
    html,body{margin:0;padding:0}
    #map{width:100vw;height:100vh}
    .menu{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;display:grid;
      grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;max-width:640px;overflow-x:auto;scrollbar-width:none;box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;margin-bottom:4px;cursor:pointer}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="menu" class="menu"></div>

<script>
/***********************  CONFIG  *********************************/
const TYPES=[['shahed',36],['shaheds',72],['orlan',36],['zala',36],['molniya',36],['lancet',36],['supercam',36],['kab',72],['rocket',72],['–Ω–µ–≤—ñ–¥–æ–º–∏–π',36]];
const ROT_OFFSET={kab:135,'–Ω–µ–≤—ñ–¥–æ–º–∏–π':0,default:45};
const MAX_POINTS=7;           // –º–∞—Ä—à—Ä—É—Ç–Ω–∏–π –±—É—Ñ–µ—Ä
const ANIM_MS=6000;           // —Ü–∏–∫–ª –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–ø–ª–∞
const SMALL_ARROW=8;          // —Ä–æ–∑–º—ñ—Ä ¬´–±—ñ–≥–∞—é—á–∏—Ö¬ª —Å—Ç—Ä—ñ–ª–æ–∫
const REPEAT='10%';           // –∫—Ä–æ–∫ –º—ñ–∂ —Å—Ç—Ä—ñ–ª–∫–∞–º–∏
/******************************************************************/

let map=null;const drones=[];
const hasRotate=typeof L.rotatedMarker==='function';

function makeIcon(name,size){return L.icon({iconUrl:`${name}.png`,iconSize:[size,size],iconAnchor:[size/2,size/2]});}
function bearing(a,b){const œÜ1=a.lat*Math.PI/180,œÜ2=b.lat*Math.PI/180,ŒîŒª=(b.lng-a.lng)*Math.PI/180;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);return(Math.atan2(y,x)*180/Math.PI+360)%360;}

/* Popup helper                         */
window.removeDrone=idx=>{const dr=drones[idx];if(!dr)return;cancelAnimationFrame(dr._raf);cancelAnimationFrame(dr._arrowRAF);[dr.marker,dr.shadow,dr.line,dr.decor].forEach(l=>l && map.removeLayer(l));drones[idx]=null;};

/***********************  INIT  ***********************************/
window.addEventListener('DOMContentLoaded',()=>{
  map=L.map('map').setView([49.9,36.3],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'¬© OpenStreetMap'}).addTo(map);

  /* –º–µ–Ω—é */
  const icons={};const menu=document.getElementById('menu');let selectedType=null;let activeIdx=null; // –∞–∫—Ç–∏–≤–Ω–∏–π –¥—Ä–æ–Ω –¥–ª—è –ø—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è –∫—É—Ä—Å—É
  TYPES.forEach(([n,s])=>{icons[n]=makeIcon(n,s);const el=document.createElement('div');el.className='menu-item';el.dataset.type=n;el.innerHTML=`<button><img src="${n}.png"></button><span>${n}</span>`;menu.appendChild(el);});
  menu.addEventListener('click',e=>{const it=e.target.closest('.menu-item');if(!it)return;menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));it.classList.add('selected');selectedType=it.dataset.type;activeIdx=null;});
  menu.addEventListener('wheel',e=>{if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY;}});

  /* –¥–æ–¥–∞—î–º–æ —á–∏ –º–∞–ª—é—î–º–æ –∫—É—Ä—Å */
  map.on('click',e=>{
    // —è–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ –¥—Ä–æ–Ω–∞ –¥–ª—è –∫—É—Ä—Å—É
    if(activeIdx!==null){
      const dr=drones[activeIdx];const A=dr.marker.getLatLng();const B=e.latlng;setCourse(dr,A,B);activeIdx=null;return;}

    // —è–∫—â–æ —î –≤–∏–±—Ä–∞–Ω–∏–π —Ç–∏–ø ‚Äî —Å—Ç–∞–≤–∏–º–æ –Ω–æ–≤–æ–≥–æ –±–ø–ª–∞
    if(!selectedType||!(selectedType in icons))return;
    const idx=drones.length;
    const marker=L.marker(e.latlng,{icon:icons[selectedType],draggable:true,rotationOrigin:'center'}).addTo(map);
    const shadow=L.polyline([],{color:'#fff',weight:4,opacity:.5,interactive:false}).addTo(map);
    const line=L.polyline([],{color:'#000',weight:2,interactive:false}).addTo(map);

    const dr={marker,shadow,line,decor:null,rotOffset:ROT_OFFSET[selectedType]??ROT_OFFSET.default,path:[e.latlng],dragging:false,_raf:0,_arrowRAF:0};
    drones.push(dr);

    marker.on('dragstart',()=>dr.dragging=true);
    marker.on('dragend',()=>{dr.dragging=false;activeIdx=null;});

    // –∫–ª—ñ–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –≤–∏–±–∏—Ä–∞—î–º–æ –π–æ–≥–æ –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –∫—É—Ä—Å—É
    marker.on('click',ev=>{activeIdx=idx;ev.originalEvent.stopPropagation();});

    // popup —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    marker.bindPopup(`<button onclick="removeDrone(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>`);
  });
});

/***********************  –§—É–Ω–∫—Ü—ñ—ó –∫—É—Ä—Å—É  ***************************/
function setCourse(dr,A,B){
  // –æ–Ω–æ–≤–∏—Ç–∏ —à–ª—è—Ö
  dr.path=[A,B]; // –º–∏ —Ç—Ä–∏–º–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ 2 —Ç–æ—á–∫–∏ –¥–ª—è —á—ñ—Ç–∫–æ–≥–æ A->B
  dr.shadow.setLatLngs(dr.path);
  dr.line.setLatLngs(dr.path);

  const ang=bearing(A,B);
  if(dr.marker.setRotationAngle)dr.marker.setRotationAngle(ang-dr.rotOffset);

  drawArrows(dr);
  startLoop(dr,A,B);
}

function drawArrows(dr){
  if(dr.decor)map.removeLayer(dr.decor);
  dr.decor=L.polylineDecorator(dr.line,{interactive:false,patterns:[{offset:'0%',repeat:REPEAT,symbol:L.Symbol.arrowHead({pixelSize:SMALL_ARROW,polygon:false,pathOptions:{stroke:true,color:'#000',weight:2,interactive:false}})}]}).addTo(map);
  animateArrows(dr);
}

/***********************  –ê–Ω—ñ–º–∞—Ü—ñ—è   ******************************/
function startLoop(dr,A,B){cancelAnimationFrame(dr._raf);const step=ts=>{const t=((ts)%ANIM_MS)/ANIM_MS;const lat=A.lat+(B.lat-A.lat)*t;const lng=A.lng+(B.lng-A.lng)*t;dr.marker.setLatLng([lat,lng]);dr._raf=requestAnimationFrame(step);};dr._raf=requestAnimationFrame(step);}
function animateArrows(dr){cancelAnimationFrame(dr._arrowRAF);let off=0;const tick=()=>{off=(off+1)%100;if(dr.decor)dr.decor.setPatterns([{offset:`${off}%`,repeat:REPEAT,symbol:L.Symbol.arrowHead({pixelSize:SMALL_ARROW,polygon:false,pathOptions:{stroke:true,color:'#000',weight:2,interactive:false}})}]);dr._arrowRAF=requestAnimationFrame(tick);};tick();}
</script>
</body>
</html>
