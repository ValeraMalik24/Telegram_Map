<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <!-- –ü–ª–∞–≥—ñ–Ω –ø–æ–≤–æ—Ä–æ—Ç—É -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html,body{margin:0;padding:0}
    #map{height:100vh;width:100vw}

    /* –ü–∞–Ω–µ–ª—å menu ---------------------------------------------------------- */
    .menu{
      position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;
      display:grid;grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;
      max-width:640px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;
      box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu::after{content:'';position:absolute;top:0;right:0;width:32px;height:100%;
      pointer-events:none;background:linear-gradient(to right,rgba(255,255,255,0),rgba(0,0,0,.15))}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;cursor:pointer;margin-bottom:4px}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –ú–µ–Ω—é —Ç–∏–ø—ñ–≤ —Ü—ñ–ª–µ–π -->
<div id="menu" class="menu">
  <div class="menu-item" data-type="shahed"><button><img src="shahed.png"></button><span>Shahed</span></div>
  <div class="menu-item" data-type="shaheds"><button><img src="Shaheds.png"></button><span>Shaheds</span></div>
  <div class="menu-item" data-type="orlan"><button><img src="orlan.png"></button><span>Orlan</span></div>
  <div class="menu-item" data-type="zala"><button><img src="zala.png"></button><span>Zala</span></div>
  <div class="menu-item" data-type="molniya"><button><img src="molniya.png"></button><span>Molniya</span></div>
  <div class="menu-item" data-type="lancet"><button><img src="lancet.png"></button><span>Lancet</span></div>
  <div class="menu-item" data-type="supercam"><button><img src="supercam.png"></button><span>Supercam</span></div>
  <div class="menu-item" data-type="kab"><button><img src="Kab.png"></button><span>–ö–ê–ë</span></div>
  <div class="menu-item" data-type="rocket"><button><img src="Rocket.png"></button><span>–†–∞–∫–µ—Ç–∞</span></div>
  <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π"><button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png"></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span></div>
</div>

<script>
/* ------------------------------------------------------------------------
   1.  –ö–∞—Ä—Ç–∞
------------------------------------------------------------------------ */
const map = L.map('map').setView([49.9, 36.3], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18,
  attribution:'&copy; OpenStreetMap contributors',
  crossOrigin:null          // —â–æ–± –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±–ª–æ–∫—É–≤–∞–≤ CORS
}).addTo(map);

/* ------------------------------------------------------------------------
   2.  –Ü–∫–æ–Ω–∫–∏ —Ç–∞ —ó—Ö–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
------------------------------------------------------------------------ */
function makeIcon(url,size){
  return L.icon({
    iconUrl:url,
    iconSize:[size,size],
    iconAnchor:[size/2,size/2]   // —Ü–µ–Ω—Ç—Ä = —Ç–æ—á–∫–∞ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è
  });
}
const icons={
  shahed  :makeIcon('shahed.png',36),
  shaheds :makeIcon('Shaheds.png',72),
  orlan   :makeIcon('orlan.png',36),
  zala    :makeIcon('zala.png',36),
  molniya :makeIcon('molniya.png',36),
  lancet  :makeIcon('lancet.png',36),
  supercam:makeIcon('supercam.png',36),
  kab     :makeIcon('Kab.png',72),
  rocket  :makeIcon('Rocket.png',72),
  "–Ω–µ–≤—ñ–¥–æ–º–∏–π":makeIcon('–Ω–µ–≤—ñ–¥–æ–º–∏–π.png',36)
};

/* ¬´–Ω–æ—Å¬ª PNG: –∫—É–¥–∏ –º–∞—î –¥–∏–≤–∏—Ç–∏—Å—å –ø—Ä–∏ –∫—É—Ä—Å—ñ 0¬∞               */
const rotOffset={kab:135,"–Ω–µ–≤—ñ–¥–æ–º–∏–π":0,default:45};

/* ------------------------------------------------------------------------
   3.  –°—Ç–∞–Ω —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
------------------------------------------------------------------------ */
let selected=null;           // –≤–∏–±—Ä–∞–Ω–∏–π —Ç–∏–ø —ñ–∑ –º–µ–Ω—é
const drones=[];             // –º–∞—Å–∏–≤ —É—Å—ñ—Ö –æ–±'—î–∫—Ç—ñ–≤
const MAX_TAIL=6;            // 1 –ø–µ—Ä—à–∞ + 5 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ç–æ—á–æ–∫
const FLIGHT_MS=1200;        // —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó (–ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)

/* ------------------------------------------------------------------------
   4.  –ú–µ–Ω—é
------------------------------------------------------------------------ */
const menu=document.getElementById('menu');
menu.addEventListener('click',e=>{
  const item=e.target.closest('.menu-item');
  if(!item)return;
  menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));
  item.classList.add('selected');
  selected=item.dataset.type;
});
menu.addEventListener('wheel',e=>{
  if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY;}
});

/* ------------------------------------------------------------------------
   5.  –î–æ–ø–æ–º—ñ–∂–Ω—ñ –≥–µ–æ-—Ñ—É–Ω–∫—Ü—ñ—ó
------------------------------------------------------------------------ */
// —Ç–æ—á–∫–∞ –Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ dist –∫–º –∑–∞ –∞–∑–∏–º—É—Ç–æ–º brng ¬∞
function dest(lat,lng,brng,distKm){
  const R=6371,d=distKm/R,b=brng*Math.PI/180,
        œÜ1=lat*Math.PI/180, Œª1=lng*Math.PI/180;
  const œÜ2=Math.asin(Math.sin(œÜ1)*Math.cos(d)+Math.cos(œÜ1)*Math.sin(d)*Math.cos(b));
  const Œª2=Œª1+Math.atan2(Math.sin(b)*Math.sin(d)*Math.cos(œÜ1),Math.cos(d)-Math.sin(œÜ1)*Math.sin(œÜ2));
  return[L.latLng(œÜ2*180/Math.PI,Œª2*180/Math.PI)];
}

// –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î —á–µ—Ä–≤–æ–Ω—É —Å—Ç—Ä—ñ–ª–∫—É
function drawArrow(dr,pos){
  if(dr.arrow) map.removeLayer(dr.arrow);
  if(dr.heading===undefined) return;
  dr.arrow = L.polyline([pos, ...dest(pos.lat,pos.lng,dr.heading,2)], // 2 –∫–º
                        {color:'red',weight:4,dashArray:'6,4'}).addTo(map);
}

/* ------------------------------------------------------------------------
   6.  –ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–ª—ñ—Ç
------------------------------------------------------------------------ */
function animateFlight(dr,start,end,ms=FLIGHT_MS){
  const dLat=end.lat-start.lat, dLng=end.lng-start.lng;
  let t0=null;
  function step(ts){
    t0??=ts;
    const p=Math.min((ts-t0)/ms,1),
          cur=L.latLng(start.lat+dLat*p, start.lng+dLng*p);
    dr.marker.setLatLng(cur);

    // live-—Ö–≤—ñ—Å—Ç
    const live=[...dr.pts,cur];
    dr.shadow.setLatLngs(live);
    dr.line.setLatLngs(live);
    drawArrow(dr,cur);

    p<1 ? requestAnimationFrame(step)
        : ( ()=>{ dr.pts.push(end);
                  while(dr.pts.length>MAX_TAIL) dr.pts.shift();
                  drawArrow(dr,end);} )();
  }
  requestAnimationFrame(step);
}

/* ------------------------------------------------------------------------
   7.  –†–æ–±–æ—Ç–∞ –∑ –∫—É—Ä—Å–æ–º
------------------------------------------------------------------------ */
function setHeading(idx,val){
  val=parseFloat(val); if(isNaN(val))return;
  const d=drones[idx]; d.heading=val;
  d.marker.setRotationAngle(val-d.rot);
  drawArrow(d,d.marker.getLatLng());
}

/* ------------------------------------------------------------------------
   8.  –î–æ–¥–∞—î–º–æ —Ü—ñ–ª—å
------------------------------------------------------------------------ */
map.on('click',e=>{
  if(!selected||!(selected in icons))return;

  const rot=rotOffset[selected]??rotOffset.default;
  const marker=L.marker(e.latlng,{
    icon:icons[selected],
    draggable:true,
    rotationAngle:0,rotationOrigin:'center'
  }).addTo(map);

  const shadow=L.polyline([e.latlng],{color:'#fff',weight:8,opacity:.6}).addTo(map);
  const line  =L.polyline([e.latlng],{color:'#000',weight:4}).addTo(map);

  const idx=drones.length;
  const dr={marker,shadow,line,arrow:null,pts:[e.latlng],rot,heading:undefined};
  drones.push(dr);

  /* drag-–ª–æ–≥—ñ–∫–∞ */
  let dragStart;
  marker.on('dragstart',()=>dragStart=marker.getLatLng());
  marker.on('dragend',()=>{
    animateFlight(dr,dragStart,marker.getLatLng());
  });

  /* pop-up */
  marker.bindPopup(`
    <b>${selected.toUpperCase()}</b><br>
    –ö—É—Ä—Å: <input id="h_${idx}" type="number" min="0" max="359" value="0" style="width:60px">
    <button onclick="setHeading(${idx},document.getElementById('h_${idx}').value)">OK</button><br>
    <button onclick="del(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
  `).openPopup();
});

/* ------------------------------------------------------------------------
   9.  –í–∏–¥–∞–ª–∏—Ç–∏
------------------------------------------------------------------------ */
function del(i){
  const d=drones[i]; if(!d)return;
  [d.marker,d.shadow,d.line,d.arrow].forEach(l=>l&&map.removeLayer(l));
  drones[i]=null;
}
</script>
</body>
</html>
