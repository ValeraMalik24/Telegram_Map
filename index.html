<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>

  <!-- –ü–ª–∞–≥—ñ–Ω –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html, body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }

    /* === –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–µ–Ω—é (Grid + —Å–∫—Ä–æ–ª) === */
    .menu {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      border-radius: 8px;
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: min-content;
      gap: 12px;
      max-width: 640px;
      overflow-x: auto;
      scrollbar-width: none;          /* Firefox */
      -ms-overflow-style: none;       /* IE/Edge */
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
      z-index: 1000;
    }
    .menu::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    /* –ø—Ä–∞–≤–∏–π –≥—Ä–∞–¥—ñ—î–Ω—Ç-–ø—ñ–¥–∫–∞–∑–∫–∞ */
    .menu::after {
      content: "";
      position: absolute;
      top: 0; right: 0;
      width: 32px; height: 100%;
      pointer-events: none;
      background: linear-gradient(to right, rgba(255,255,255,0), rgba(0,0,0,0.15));
    }

    .menu-item {
      text-align: center;
      font-size: 12px;
      font-family: sans-serif;
    }

    .menu-item button {
      background: none;
      border: 2px solid transparent;
      cursor: pointer;
      display: block;
      margin-bottom: 4px;
      border-radius: 6px;
      padding: 2px;
    }

    .menu-item.selected button {
      border-color: #007bff;
      box-shadow: 0 0 4px #007bff;
    }

    .menu-item img {
      width: 36px;
      height: 36px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- –ú–µ–Ω—é –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –ë–ø–õ–ê -->
<div class="menu" id="menu">
  <div class="menu-item" data-type="shahed">
    <button><img src="shahed.png" /></button><span>Shahed</span>
  </div>
  <div class="menu-item" data-type="orlan">
    <button><img src="orlan.png" /></button><span>Orlan</span>
  </div>
  <div class="menu-item" data-type="zala">
    <button><img src="zala.png" /></button><span>Zala</span>
  </div>
  <div class="menu-item" data-type="molniya">
    <button><img src="molniya.png" /></button><span>Molniya</span>
  </div>
  <div class="menu-item" data-type="lancet">
    <button><img src="lancet.png" /></button><span>Lancet</span>
  </div>
  <div class="menu-item" data-type="supercam">
    <button><img src="supercam.png" /></button><span>Supercam</span>
  </div>
  <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π">
    <button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png" /></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span>
  </div>
</div>

<script>
/***** 1. –ö–∞—Ä—Ç–∞ *****/
const map = L.map('map').setView([49.9, 36.3], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/***** 2. –Ü–∫–æ–Ω–∫–∏ *****/
const icons = {
  shahed:   L.icon({ iconUrl: 'shahed.png',   iconSize: [36, 36] }),
  orlan:    L.icon({ iconUrl: 'orlan.png',    iconSize: [36, 36] }),
  zala:     L.icon({ iconUrl: 'zala.png',     iconSize: [36, 36] }),
  molniya:  L.icon({ iconUrl: 'molniya.png',  iconSize: [36, 36] }),
  lancet:   L.icon({ iconUrl: 'lancet.png',   iconSize: [36, 36] }),
  supercam: L.icon({ iconUrl: 'supercam.png', iconSize: [36, 36] }),
  "–Ω–µ–≤—ñ–¥–æ–º–∏–π": L.icon({ iconUrl: '–Ω–µ–≤—ñ–¥–æ–º–∏–π.png', iconSize: [36, 36] })
};

/***** 3. –°—Ç–∞–Ω *****/
let selectedType = null;
const drones = [];
const MAX_TAIL_POINTS = 6; // 1 —Å—Ç–∞—Ä—Ç + 5 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ç–æ—á–æ–∫ => 5 —Å–µ–≥–º–µ–Ω—Ç—ñ–≤

/***** 4. –ú–µ–Ω—é –≤–∏–±–æ—Ä—É *****/
const menu = document.getElementById('menu');
menu.addEventListener('click', e => {
  const item = e.target.closest('.menu-item');
  if (!item) return;
  document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
  item.classList.add('selected');
  selectedType = item.dataset.type;
});
// –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª –∫–æ–ª—ñ—â–∞—Ç–∫–æ–º
menu.addEventListener('wheel', e => {
  if (e.deltaY === 0) return;
  e.preventDefault();
  menu.scrollLeft += e.deltaY;
});

/***** 5. –î–æ–ø–æ–º—ñ–∂–Ω—ñ *****/
function drawMovementArrow(drone, from, to) {
  if (drone.arrow) map.removeLayer(drone.arrow);
  drone.arrow = L.polyline([from, to], {
    color: 'red',
    weight: 4,
    dashArray: '6,4'
  }).addTo(map);
}

function animateMarker(marker, start, end, duration = 500, cb) {
  const startLat = start.lat, startLng = start.lng;
  const diffLat = end.lat - start.lat;
  const diffLng = end.lng - start.lng;
  let startTime = null;
  function step(ts) {
    if (!startTime) startTime = ts;
    const progress = Math.min((ts - startTime) / duration, 1);
    marker.setLatLng([startLat + diffLat * progress, startLng + diffLng * progress]);
    if (progress < 1) requestAnimationFrame(step); else if (cb) cb();
  }
  // —Å—Ç–∞–≤–∏–º–æ –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–∞–¥ –Ω–∞ —Å—Ç–∞—Ä—Ç —ñ –ø–æ—á–∏–Ω–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
  marker.setLatLng(start);
  requestAnimationFrame(step);
}

/***** 6. –î–æ–¥–∞–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–∞ *****/
map.on('click', e => {
  if (!selectedType || !(selectedType in icons)) return;
  const rotationOffset = selectedType === "–Ω–µ–≤—ñ–¥–æ–º–∏–π" ? 0 : 45;

  // –ú–∞—Ä–∫–µ—Ä
  const marker = L.marker(e.latlng, {
    icon: icons[selectedType],
    draggable: true,
    rotationAngle: 0,
    rotationOrigin: 'center center'
  }).addTo(map);

  // –ü–æ–ª—ñ–ª—ñ–Ω–∏ (—Ç—ñ–Ω—å + –æ—Å–Ω–æ–≤–∞)
  const shadow = L.polyline([e.latlng], {
    color: '#ffffff', weight: 8, opacity: 0.6
  }).addTo(map);
  const line = L.polyline([e.latlng], {
    color: '#000000', weight: 4, opacity: 1
  }).addTo(map);

  // –û–±'—î–∫—Ç –¥—Ä–æ–Ω–∞
  const index = drones.length;
  const drone = {
    marker,
    shadow,
    line,
    arrow: null,
    coords: [e.latlng],
    rotationOffset
  };
  drones.push(drone);

  /*** Drag ***/
  let startPos;
  marker.on('dragstart', () => { startPos = marker.getLatLng(); });

  marker.on('dragend', () => {
    const endPos = marker.getLatLng();
    animateMarker(marker, startPos, endPos, 500, () => {
      // –ø—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó: –æ–Ω–æ–≤–ª—é—î–º–æ —Ö–≤—ñ—Å—Ç
      drone.coords.push(endPos);
      while (drone.coords.length > MAX_TAIL_POINTS) drone.coords.shift();
      drone.shadow.setLatLngs(drone.coords);
      drone.line.setLatLngs(drone.coords);
      if (drone.coords.length >= 2) {
        const from = drone.coords[drone.coords.length - 2];
        const to = drone.coords[drone.coords.length - 1];
        drawMovementArrow(drone, from, to);
      }
    });
  });

  /*** Popup ***/
  const popup = L.popup().setContent(`
    <b>${selectedType.toUpperCase()}</b><br>
    <button onclick="removeDrone(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
  `);
  marker.bindPopup(popup).openPopup();
});

/***** 7. –í–∏–¥–∞–ª–µ–Ω–Ω—è –¥—Ä–æ–Ω–∞ *****/
function removeDrone(index) {
  const drone = drones[index];
  if (!drone) return;
  map.removeLayer(drone.marker);
  map.removeLayer(drone.shadow);
  map.removeLayer(drone.line);
  if (drone.arrow) map.removeLayer(drone.arrow);
  drones[index] = null;
}
</script>
</body>
</html>
