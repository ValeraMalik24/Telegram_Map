<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html,body{margin:0;padding:0}
    #map{height:100vh;width:100vw}

    /* –º–µ–Ω—é */
    .menu{
      position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;
      display:grid;grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;
      max-width:640px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;
      box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu::after{content:"";position:absolute;top:0;right:0;width:32px;height:100%;
      pointer-events:none;background:linear-gradient(to right,rgba(255,255,255,0),rgba(0,0,0,.15))}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;cursor:pointer;margin-bottom:4px}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
<div id="map"></div>

<div id="menu" class="menu">
  <div class="menu-item" data-type="shahed"><button><img src="shahed.png"></button><span>Shahed</span></div>
  <div class="menu-item" data-type="shaheds"><button><img src="Shaheds.png"></button><span>Shaheds</span></div>
  <div class="menu-item" data-type="orlan"><button><img src="orlan.png"></button><span>Orlan</span></div>
  <div class="menu-item" data-type="zala"><button><img src="zala.png"></button><span>Zala</span></div>
  <div class="menu-item" data-type="molniya"><button><img src="molniya.png"></button><span>Molniya</span></div>
  <div class="menu-item" data-type="lancet"><button><img src="lancet.png"></button><span>Lancet</span></div>
  <div class="menu-item" data-type="supercam"><button><img src="supercam.png"></button><span>Supercam</span></div>
  <div class="menu-item" data-type="kab"><button><img src="Kab.png"></button><span>–ö–ê–ë</span></div>
  <div class="menu-item" data-type="rocket"><button><img src="Rocket.png"></button><span>–†–∞–∫–µ—Ç–∞</span></div>
  <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π"><button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png"></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span></div>
</div>

<script>
/* –∫–∞—Ä—Ç–∞ */
const map=L.map('map').setView([49.9,36.3],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18,
  attribution:'&copy; OpenStreetMap contributors',
  crossOrigin:null        // –≤–∞–∂–ª–∏–≤–æ –¥–ª—è CORS
}).addTo(map);

/* —ñ–∫–æ–Ω–∫–∏ */
const icons={
  shahed : L.icon({iconUrl:'shahed.png',   iconSize:[36,36]}),
  shaheds: L.icon({iconUrl:'Shaheds.png',  iconSize:[72,72]}),
  orlan  : L.icon({iconUrl:'orlan.png',    iconSize:[36,36]}),
  zala   : L.icon({iconUrl:'zala.png',     iconSize:[36,36]}),
  molniya: L.icon({iconUrl:'molniya.png',  iconSize:[36,36]}),
  lancet : L.icon({iconUrl:'lancet.png',   iconSize:[36,36]}),
  supercam:L.icon({iconUrl:'supercam.png', iconSize:[36,36]}),
  kab    : L.icon({iconUrl:'Kab.png',      iconSize:[72,72]}),
  rocket : L.icon({iconUrl:'Rocket.png',   iconSize:[72,72]}),
  "–Ω–µ–≤—ñ–¥–æ–º–∏–π":L.icon({iconUrl:'–Ω–µ–≤—ñ–¥–æ–º–∏–π.png',iconSize:[36,36]})
};

/* –ø–æ–≤–æ—Ä–æ—Ç ‚Äì –∫—É–¥–∏ –¥–∏–≤–∏—Ç—å—Å—è ¬´–Ω—ñ—Å¬ª —É PNG */
const rotationOffsetByType={ kab:135, "–Ω–µ–≤—ñ–¥–æ–º–∏–π":0, default:45 };

let selectedType=null;
const drones=[];
const MAX_TAIL=6;

/* –º–µ–Ω—é */
const menu=document.getElementById('menu');
menu.addEventListener('click',e=>{
  const item=e.target.closest('.menu-item'); if(!item)return;
  menu.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('selected'));
  item.classList.add('selected'); selectedType=item.dataset.type;
});
menu.addEventListener('wheel',e=>{if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY}});

/* —É—Ç–∏–ª—ñ—Ç–∏ */
function dest(lat,lon,b,km){
  const R=6371,d=km/R,br=b*Math.PI/180,la=lat*Math.PI/180,lo=lon*Math.PI/180;
  const la2=Math.asin(Math.sin(la)*Math.cos(d)+Math.cos(la)*Math.sin(d)*Math.cos(br));
  const lo2=lo+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(la),Math.cos(d)-Math.sin(la)*Math.sin(la2));
  return[la2*180/Math.PI,lo2*180/Math.PI];
}
function drawArrow(d){
  if(d.arrow)map.removeLayer(d.arrow);
  if(d.heading===undefined)return;
  const from=d.marker.getLatLng(),to=dest(from.lat,from.lng,d.heading,2);
  d.arrow=L.polyline([from,to],{color:'red',weight:4,dashArray:'6,4'}).addTo(map);
}
function animate(marker,s,e,d=500,cb){
  const dLat=e.lat-s.lat,dLng=e.lng-s.lng;let t0=null;
  const step=ts=>{t0??=ts;const p=Math.min((ts-t0)/d,1);
    marker.setLatLng([s.lat+dLat*p,s.lng+dLng*p]);p<1?requestAnimationFrame(step):cb&&cb();};
  marker.setLatLng(s);requestAnimationFrame(step);
}
function applyHeading(i){
  const v=parseFloat(document.getElementById(`h_${i}`).value); if(isNaN(v))return;
  const d=drones[i]; d.heading=v; d.marker.setRotationAngle(v-d.rot); drawArrow(d); d.marker.closePopup();
}

/* –¥–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å */
map.on('click',e=>{
  if(!selectedType||!(selectedType in icons))return;
  const rot=rotationOffsetByType[selectedType]??rotationOffsetByType.default;
  const m=L.marker(e.latlng,{icon:icons[selectedType],draggable:true,rotationAngle:0,rotationOrigin:'center center'}).addTo(map);
  const sh=L.polyline([e.latlng],{color:'#fff',weight:8,opacity:.6}).addTo(map);
  const ln=L.polyline([e.latlng],{color:'#000',weight:4}).addTo(map);
  const i=drones.length, d={marker:m,shadow:sh,line:ln,arrow:null,pts:[e.latlng],rot:rot,heading:undefined};
  drones.push(d);

  let s;
  m.on('dragstart',()=>{s=m.getLatLng()});
  m.on('dragend',()=>{
    const epos=m.getLatLng();
    animate(m,s,epos,500,()=>{
      d.pts.push(epos); while(d.pts.length>MAX_TAIL)d.pts.shift();
      sh.setLatLngs(d.pts); ln.setLatLngs(d.pts); drawArrow(d);
    });
  });

  m.bindPopup(`<b>${selectedType.toUpperCase()}</b><br>
    –ö—É—Ä—Å: <input id="h_${i}" type="number" min="0" max="359" value="0" style="width:60px">
    <button onclick="applyHeading(${i})">OK</button><br>
    <button onclick="removeDrone(${i})">–í–∏–¥–∞–ª–∏—Ç–∏</button>`).openPopup();
});

/* –≤–∏–¥–∞–ª–µ–Ω–Ω—è */
function removeDrone(i){
  const d=drones[i]; if(!d)return;
  [d.marker,d.shadow,d.line,d.arrow].forEach(l=>l&&map.removeLayer(l));
  drones[i]=null;
}
</script>
</body>
</html>
