<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <!-- –ü–ª–∞–≥—ñ–Ω –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html,body{margin:0;padding:0}
    #map{height:100vh;width:100vw}

    /* --- –º–µ–Ω—é --- */
    .menu{
      position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;
      display:grid;grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;
      max-width:640px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;
      box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000
    }
    .menu::-webkit-scrollbar{display:none}
    .menu::after{content:"";position:absolute;top:0;right:0;width:32px;height:100%;
      pointer-events:none;background:linear-gradient(to right,rgba(255,255,255,0),rgba(0,0,0,.15))}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;cursor:pointer;margin-bottom:4px}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –º–µ–Ω—é -->
<div id="menu" class="menu">
  <div class="menu-item" data-type="shahed"><button><img src="shahed.png"></button><span>Shahed</span></div>
  <div class="menu-item" data-type="shaheds"><button><img src="Shaheds.png"></button><span>Shaheds</span></div>
  <div class="menu-item" data-type="orlan"><button><img src="orlan.png"></button><span>Orlan</span></div>
  <div class="menu-item" data-type="zala"><button><img src="zala.png"></button><span>Zala</span></div>
  <div class="menu-item" data-type="molniya"><button><img src="molniya.png"></button><span>Molniya</span></div>
  <div class="menu-item" data-type="lancet"><button><img src="lancet.png"></button><span>Lancet</span></div>
  <div class="menu-item" data-type="supercam"><button><img src="supercam.png"></button><span>Supercam</span></div>
  <div class="menu-item" data-type="kab"><button><img src="Kab.png"></button><span>–ö–ê–ë</span></div>
  <div class="menu-item" data-type="rocket"><button><img src="Rocket.png"></button><span>–†–∞–∫–µ—Ç–∞</span></div>
  <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π"><button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png"></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span></div>
</div>

<script>
/* ---------- 1. –∫–∞—Ä—Ç–∞ ---------- */
const map = L.map('map').setView([49.9, 36.3], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

/* ---------- 2. —ñ–∫–æ–Ω–∫–∏ ---------- */
const icons = {
  shahed:  L.icon({iconUrl:'shahed.png',   iconSize:[36,36]}),
  shaheds: L.icon({iconUrl:'Shaheds.png',  iconSize:[36,36]}),
  orlan:   L.icon({iconUrl:'orlan.png',    iconSize:[36,36]}),
  zala:    L.icon({iconUrl:'zala.png',     iconSize:[36,36]}),
  molniya: L.icon({iconUrl:'molniya.png',  iconSize:[36,36]}),
  lancet:  L.icon({iconUrl:'lancet.png',   iconSize:[36,36]}),
  supercam:L.icon({iconUrl:'supercam.png', iconSize:[36,36]}),
  kab:     L.icon({iconUrl:'Kab.png',      iconSize:[36,36]}),
  rocket:  L.icon({iconUrl:'Rocket.png',   iconSize:[36,36]}),
  "–Ω–µ–≤—ñ–¥–æ–º–∏–π":L.icon({iconUrl:'–Ω–µ–≤—ñ–¥–æ–º–∏–π.png',iconSize:[36,36]})
};

/* rotation offset: —Å–∫—ñ–ª—å–∫–∏ ¬´–ø–æ–≤–µ—Ä–Ω—É—Ç–∏¬ª –∫–∞—Ä—Ç–∏–Ω–∫—É, —â–æ–± 0¬∞ = –ø—Ä—è–º—É—î –Ω–∞ N */
const rotationOffsetByType = {
  kab: 135,              // –Ω—ñ—Å —É–Ω–∏–∑-–ø—Ä–∞–≤–æ—Ä—É—á
  "–Ω–µ–≤—ñ–¥–æ–º–∏–π": 0,
  default: 45            // —ñ–Ω—à—ñ ‚Äì —É–≥–æ—Ä—É-–ø—Ä–∞–≤–æ—Ä—É—á
};

/* ---------- 3. —Å—Ç–∞–Ω ---------- */
let selectedType = null;
const drones = [];
const MAX_TAIL_POINTS = 6; // 1 + 5 = 5 —Å–µ–≥–º–µ–Ω—Ç—ñ–≤

/* ---------- 4. –º–µ–Ω—é ---------- */
const menu = document.getElementById('menu');
menu.addEventListener('click', e=>{
  const item = e.target.closest('.menu-item');
  if(!item) return;
  menu.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('selected'));
  item.classList.add('selected');
  selectedType = item.dataset.type;
});
menu.addEventListener('wheel', e=>{
  if(e.deltaY!==0){e.preventDefault();menu.scrollLeft += e.deltaY;}
});

/* ---------- 5. –¥–æ–ø–æ–º—ñ–∂–Ω—ñ ---------- */
function destinationPoint(lat, lon, brng, distKm){
  const R=6371,d=distKm/R,b=brng*Math.PI/180;
  const lat1=lat*Math.PI/180,lon1=lon*Math.PI/180;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(b));
  const lon2=lon1+Math.atan2(Math.sin(b)*Math.sin(d)*Math.cos(lat1),Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

function drawHeadingArrow(drone){
  if(drone.headingArrow) map.removeLayer(drone.headingArrow);
  if(drone.heading===undefined) return;
  const from = drone.marker.getLatLng();
  const to   = destinationPoint(from.lat, from.lng, drone.heading, 2);
  drone.headingArrow = L.polyline([from,to],{color:'red',weight:4,dashArray:'6,4'}).addTo(map);
}

function animateMarker(marker,start,end,dur=500,cb){
  const dLat=end.lat-start.lat,dLng=end.lng-start.lng;let t0=null;
  function step(ts){ if(!t0) t0=ts; const p=Math.min((ts-t0)/dur,1);
    marker.setLatLng([start.lat+dLat*p, start.lng+dLng*p]);
    p<1?requestAnimationFrame(step):cb&&cb();
  }
  marker.setLatLng(start); requestAnimationFrame(step);
}

function applyHeading(idx){
  const inp=document.getElementById(`headingInput_${idx}`); if(!inp) return;
  const val=parseFloat(inp.value); if(isNaN(val)) return;
  const d=drones[idx]; if(!d) return;
  d.heading = val;
  d.marker.setRotationAngle(val - d.rotationOffset);
  drawHeadingArrow(d); d.marker.closePopup();
}

/* ---------- 6. –¥–æ–¥–∞—î–º–æ —Ü—ñ–ª—å ---------- */
map.on('click', e=>{
  if(!selectedType || !(selectedType in icons)) return;
  const rotOff = rotationOffsetByType[selectedType] ?? rotationOffsetByType.default;

  const marker = L.marker(e.latlng,{
    icon:icons[selectedType], draggable:true, rotationAngle:0, rotationOrigin:'center center'
  }).addTo(map);

  const shadow = L.polyline([e.latlng],{color:'#fff',weight:8,opacity:.6}).addTo(map);
  const line   = L.polyline([e.latlng],{color:'#000',weight:4,opacity:1}).addTo(map);

  const idx=drones.length;
  const drone={marker,shadow,line,headingArrow:null,coords:[e.latlng],rotationOffset:rotOff,heading:undefined};
  drones.push(drone);

  let dragStart;
  marker.on('dragstart',()=>{dragStart=marker.getLatLng();});
  marker.on('dragend',()=>{
    const dragEnd=marker.getLatLng();
    animateMarker(marker,dragStart,dragEnd,500,()=>{
      drone.coords.push(dragEnd);
      while(drone.coords.length>MAX_TAIL_POINTS) drone.coords.shift();
      shadow.setLatLngs(drone.coords); line.setLatLngs(drone.coords);
      drawHeadingArrow(drone);
    });
  });

  marker.bindPopup(
    `<b>${selectedType.toUpperCase()}</b><br>
     –ö—É—Ä—Å (0‚Äì359¬∞): <input id="headingInput_${idx}" type="number" min="0" max="359" value="0" style="width:60px"><br>
     <button onclick="applyHeading(${idx})">OK</button>
     <button onclick="removeDrone(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>`
  ).openPopup();
});

/* ---------- 7. –≤–∏–¥–∞–ª–µ–Ω–Ω—è ---------- */
function removeDrone(idx){
  const d=drones[idx]; if(!d) return;
  [d.marker,d.shadow,d.line,d.headingArrow].forEach(l=>l && map.removeLayer(l));
  drones[idx] = null;
}
</script>
</body>
</html>
