<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.png">

  <!-- Leaflet core only (–Ω–µ–º–∞—î —Å—Ç–æ—Ä–æ–Ω–Ω—ñ—Ö –ø–ª–∞–≥—ñ–Ω—ñ–≤, —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ –ª–∞–º–∞–ª–æ—Å—å) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- –Ñ–¥–∏–Ω–∏–π –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π –ø–ª–∞–≥—ñ–Ω ‚Äî –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç—É —ñ–∫–æ–Ω–æ–∫. –í—ñ–Ω –Ω–µ–≤–µ–ª–∏–∫–∏–π —ñ –Ω–∞–¥—ñ–π–Ω–∏–π. -->
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
    html,body{margin:0;padding:0}
    #map{width:100vw;height:100vh}
    .menu{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.95);padding:8px 12px;border-radius:8px;display:grid;
      grid-auto-flow:column;grid-auto-columns:min-content;gap:12px;max-width:640px;overflow-x:auto;
      scrollbar-width:none;box-shadow:0 0 6px rgba(0,0,0,.25);z-index:1000}
    .menu::-webkit-scrollbar{display:none}
    .menu-item{text-align:center;font:12px/1 sans-serif}
    .menu-item button{background:none;border:2px solid transparent;border-radius:6px;padding:2px;margin-bottom:4px;cursor:pointer}
    .menu-item.selected button{border-color:#007bff;box-shadow:0 0 4px #007bff}
    .menu-item img{width:36px;height:36px;border-radius:4px}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="menu" class="menu"></div>

<script>
/***********************  CONFIG  *********************************/
const TYPES=[['shahed',36],['shaheds',72],['orlan',36],['zala',36],['molniya',36],['lancet',36],['supercam',36],['kab',72],['rocket',72],['–Ω–µ–≤—ñ–¥–æ–º–∏–π',36]];
const ROT_OFFSET={kab:135,'–Ω–µ–≤—ñ–¥–æ–º–∏–π':0,default:45};
const PROJ_DIST=3000;        // –ø—Ä–æ–≥–Ω–æ–∑ 3 –∫–º
/******************************************************************/

let map=null;
const drones=[];
let selectedType=null;
let activeIdx=null;

/* ---------------------------------------------------------------- utils */
const makeIcon=(n,s)=>L.icon({iconUrl:`${n}.png`,iconSize:[s,s],iconAnchor:[s/2,s/2]});
function bearing(a,b){const r=Math.PI/180;const œÜ1=a.lat*r,œÜ2=b.lat*r,ŒîŒª=(b.lng-a.lng)*r;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2),x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);return(Math.atan2(y,x)*180/Math.PI+360)%360;}
function destPoint(pt,brg,dist){const R=6371000,Œ¥=dist/R,Œ∏=brg*Math.PI/180;const œÜ1=pt.lat*Math.PI/180,Œª1=pt.lng*Math.PI/180;const œÜ2=Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥)+Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(Œ∏));const Œª2=Œª1+Math.atan2(Math.sin(Œ∏)*Math.sin(Œ¥)*Math.cos(œÜ1),Math.cos(Œ¥)-Math.sin(œÜ1)*Math.sin(œÜ2));return L.latLng(œÜ2*180/Math.PI,(Œª2*180/Math.PI+540)%360-180);} // –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

/* ---------------------------------------------------------------- popup helpers */
window.removeDrone=i=>{const d=drones[i];if(!d)return;cancelAnimationFrame(d._anim);[d.marker,d.line,d.shadow,d.arrow,d.proj].forEach(l=>l&&map.removeLayer(l));drones[i]=null;};
window.setParams=(i,a,s)=>{const d=drones[i];if(d){d.alt=+a||0;d.speed=+s||0;d.marker.closePopup();}}

/* ---------------------------------------------------------------- init */
document.addEventListener('DOMContentLoaded',()=>{
  /* –∫–∞—Ä—Ç–∞ */
  map=L.map('map').setView([49.9,36.3],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'¬© OpenStreetMap'}).addTo(map);

  /* –º–µ–Ω—é */
  const icons={},menu=document.getElementById('menu');
  TYPES.forEach(([n,s])=>{icons[n]=makeIcon(n,s);menu.insertAdjacentHTML('beforeend',`<div class='menu-item' data-type='${n}'><button><img src='${n}.png'></button><span>${n}</span></div>`)});
  menu.onclick=e=>{const it=e.target.closest('.menu-item');if(!it)return;menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));it.classList.add('selected');selectedType=it.dataset.type;activeIdx=null;};
  menu.onwheel=e=>{if(e.deltaY){e.preventDefault();menu.scrollLeft+=e.deltaY;}};

  /* –∫–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ */
  map.on('click',e=>{
    if(activeIdx!==null){const d=drones[activeIdx];setCourse(d,d.marker.getLatLng(),e.latlng);activeIdx=null;return;}
    if(selectedType){addDrone(e.latlng,selectedType,icons[selectedType]);menu.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('selected'));selectedType=null;}
  });
});

/* ---------------------------------------------------------------- add drone */
function addDrone(lat,type,icon){
  const idx=drones.length;
  const marker=L.marker(lat,{icon,draggable:true,rotationOrigin:'center'}).addTo(map);
  const line=L.polyline([], {color:'#000',weight:2}).addTo(map);
  const shadow=L.polyline([], {color:'#fff',weight:4,opacity:.5}).addTo(map);
  const d={marker,line,shadow,arrow:null,proj:null,rotOffset:ROT_OFFSET[type]??ROT_OFFSET.default,path:[lat],_anim:0,alt:0,speed:0};
  drones.push(d);

  marker.on('dragstart',()=>d.dragging=true);
  marker.on('dragend',()=>{d.dragging=false;activeIdx=null;});
  marker.on('click',ev=>{activeIdx=idx;ev.originalEvent.stopPropagation();});

  marker.bindPopup(`–í–∏—Å–æ—Ç–∞: <input id='alt${idx}' type='number' style='width:50px'>–º<br>–®–≤–∏–¥–∫—ñ—Å—Ç—å: <input id='spd${idx}' type='number' style='width:50px'>–∫–º/–≥–æ–¥<br><button onclick='setParams(${idx},alt${idx}.value,spd${idx}.value)'>OK</button><br><button onclick='removeDrone(${idx})'>–í–∏–¥–∞–ª–∏—Ç–∏</button>`);
}

/* ---------------------------------------------------------------- course + projection */
function setCourse(d,A,B){
  d.path=[A,B]; d.line.setLatLngs(d.path); d.shadow.setLatLngs(d.path);
  const ang=bearing(A,B); d.marker.setRotationAngle?.(ang-d.rotOffset);
  drawArrow(d,A,B,ang); drawProjection(d,B,ang); startAnim(d,A,B);
}
function drawArrow(d,A,B,ang){ // –æ–¥–Ω–∞ —Å—Ç—Ä—ñ–ª–∫–∞ —É —Ü–µ–Ω—Ç—Ä—ñ –≤—ñ–¥—Ä—ñ–∑–∫–∞
  if(d.arrow)map.removeLayer(d.arrow);
  const mid=L.latLng((A.lat+B.lat)/2,(A.lng+B.lng)/2);
  d.arrow=L.rotatedMarker(mid,{icon:makeIcon('arrow',24),rotationAngle:ang-90,interactive:false}).addTo(map);
}
function drawProjection(d,start,ang){
  d.proj&&map.removeLayer(d.proj);
  d.proj=L.polyline([start,destPoint(start,ang,PROJ_DIST)],{color:'#000',weight:1,dashArray:'6 6'}).addTo(map);
}

function startAnim(d,A,B){
  cancelAnimationFrame(d._anim);
  const run=t=>{const p=((t)%4000)/4000;d.marker.setLatLng([A.lat+(B.lat-A.lat)*p,A.lng+(B.lng-A.lng)*p]);d._anim=requestAnimationFrame(run);} ;
  d._anim=requestAnimationFrame(run);
}
</script>
</body>
</html>
