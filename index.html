<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–æ—è–Ω–¥–∞ –Ü–ù–§–ûüì°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ -->
  <link rel="stylesheet" href="style.css" />

  <style>
    html, body { margin:0; padding:0; }
    #map { width:100vw; height:100vh; }

    .menu {
      position:absolute;
      bottom:10px; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.95);
      padding:8px 12px;
      border-radius:8px;
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:min-content;
      gap:12px;
      max-width:640px;
      overflow-x:auto;
      scrollbar-width:none;
      box-shadow:0 0 6px rgba(0,0,0,0.25);
      z-index:1000;
    }
    .menu::-webkit-scrollbar { display:none; }
    .menu-item { text-align:center; font:12px/1 sans-serif; }
    .menu-item button {
      background:none;
      border:2px solid transparent;
      border-radius:6px;
      padding:2px;
      margin-bottom:4px;
      cursor:pointer;
    }
    .menu-item.selected button {
      border-color:#007bff;
      box-shadow:0 0 4px #007bff;
    }
    .menu-item img { width:36px; height:36px; border-radius:4px; }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–µ–Ω—é —Ç–∏–ø—ñ–≤ –ë–ø–õ–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="menu" class="menu">
    <div class="menu-item" data-type="shahed"><button><img src="shahed.png" alt="Shahed"></button><span>Shahed</span></div>
    <div class="menu-item" data-type="shaheds"><button><img src="Shaheds.png" alt="Shaheds"></button><span>Shaheds</span></div>
    <div class="menu-item" data-type="orlan"><button><img src="orlan.png" alt="Orlan"></button><span>Orlan</span></div>
    <div class="menu-item" data-type="zala"><button><img src="zala.png" alt="Zala"></button><span>Zala</span></div>
    <div class="menu-item" data-type="molniya"><button><img src="molniya.png" alt="Molniya"></button><span>Molniya</span></div>
    <div class="menu-item" data-type="lancet"><button><img src="lancet.png" alt="Lancet"></button><span>Lancet</span></div>
    <div class="menu-item" data-type="supercam"><button><img src="supercam.png" alt="Supercam"></button><span>Supercam</span></div>
    <div class="menu-item" data-type="kab"><button><img src="Kab.png" alt="–ö–ê–ë"></button><span>–ö–ê–ë</span></div>
    <div class="menu-item" data-type="rocket"><button><img src="Rocket.png" alt="Rocket"></button><span>–†–∞–∫–µ—Ç–∞</span></div>
    <div class="menu-item" data-type="–Ω–µ–≤—ñ–¥–æ–º–∏–π"><button><img src="–Ω–µ–≤—ñ–¥–æ–º–∏–π.png" alt="Unknown"></button><span>–ù–µ–≤—ñ–¥–æ–º–∏–π</span></div>
  </div>

  <!-- Leaflet —Ç–∞ –ø–ª–∞–≥—ñ–Ω –ø–æ–≤–æ—Ä–æ—Ç—É -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <script>
    /* ---------------------------------------------------------------------
       –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω ‚Äî –æ–¥—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–Ω–∏–π popup‚Äë—Å–∫—Ä–∏–ø—Ç–∞–º
    --------------------------------------------------------------------- */
    window.drones = [];     // –º–∞—Å–∏–≤ –≤—Å—ñ—Ö –¥—Ä–æ–Ω—ñ–≤
    window.map    = null;   // –∫–∞—Ä—Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ

    /**
     * –ü–æ–≤–µ—Ä—Ç–∞—î –∞–∑–∏–º—É—Ç (0‚Äë359¬∞) –≤—ñ–¥ —Ç–æ—á–∫–∏ a –¥–æ —Ç–æ—á–∫–∏ b
     */
    function bearing(a, b) {
      const œÜ1 = a.lat * Math.PI/180,
            œÜ2 = b.lat * Math.PI/180,
            ŒîŒª = (b.lng - a.lng) * Math.PI/180;
      const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      return (Math.atan2(y, x) * 180/Math.PI + 360) % 360;
    }

    /**
     * –ó–º—ñ–Ω–∏—Ç–∏ –∫—É—Ä—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥—Ä–æ–Ω–∞ (–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ popup)
     */
    window.setHeading = function (idx, val) {
      const v = parseFloat(val);
      if (isNaN(v)) return;
      const dr = window.drones[idx];
      if (!dr) return;
      dr.marker.setRotationAngle(v - dr.rotOffset);
      if (dr.arrow) dr.arrow.setRotationAngle(v - 90);
      dr.marker.closePopup();
    };

    /**
     * –í–∏–¥–∞–ª–∏—Ç–∏ –¥—Ä–æ–Ω–∞ —Ç–∞ –≤—Å—ñ –≥—Ä–∞—Ñ—ñ—á–Ω—ñ –æ–±‚Äô—î–∫—Ç–∏
     */
    window.removeDrone = function (idx) {
      const dr = window.drones[idx];
      if (!dr) return;
      cancelAnimationFrame(dr._anim);
      [dr.marker, dr.shadow, dr.line, dr.arrow].forEach(l => l && window.map.removeLayer(l));
      window.drones[idx] = null;
    };

    /* ---------------------------------------------------------------------
       –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ ‚Äî –ø—ñ—Å–ª—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ DOM
    --------------------------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      /* ‚îÄ‚îÄ 1. –ö–∞—Ä—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      window.map = L.map('map').setView([49.9, 36.3], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(window.map);

      /* ‚îÄ‚îÄ 2. –Ü–∫–æ–Ω–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      function makeIcon(url, size) {
        return L.icon({ iconUrl:url, iconSize:[size,size], iconAnchor:[size/2,size/2] });
      }
      const icons = {
        shahed:   makeIcon('shahed.png', 36),
        shaheds:  makeIcon('Shaheds.png', 72),
        orlan:    makeIcon('orlan.png', 36),
        zala:     makeIcon('zala.png', 36),
        molniya:  makeIcon('molniya.png', 36),
        lancet:   makeIcon('lancet.png', 36),
        supercam: makeIcon('supercam.png', 36),
        kab:      makeIcon('Kab.png', 72),
        rocket:   makeIcon('Rocket.png', 72),
        '–Ω–µ–≤—ñ–¥–æ–º–∏–π': makeIcon('–Ω–µ–≤—ñ–¥–æ–º–∏–π.png', 36)
      };
      const arrowIcon = makeIcon('arrow.png', 24);
      const rotOffset = { kab:135, '–Ω–µ–≤—ñ–¥–æ–º–∏–π':0, default:45 };

      /* ‚îÄ‚îÄ 3. –ú–µ–Ω—é –≤–∏–±–æ—Ä—É —Ç–∏–ø—ñ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const menu = document.getElementById('menu');
      let selected = null;
      menu.addEventListener('click', e => {
        const item = e.target.closest('.menu-item');
        if (!item) return;
        menu.querySelectorAll('.menu-item').forEach(x => x.classList.remove('selected'));
        item.classList.add('selected');
        selected = item.dataset.type;
      });
      menu.addEventListener('wheel', e => {
        if (e.deltaY) { e.preventDefault(); menu.scrollLeft += e.deltaY; }
      });

      /* ‚îÄ‚îÄ 4. –ê–Ω—ñ–º–∞—Ü—ñ—è –¥—Ä–æ–Ω–∞ –º—ñ–∂ –æ—Å—Ç–∞–Ω–Ω—ñ–º–∏ —Ç–æ—á–∫–∞–º–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const LOOP_MS = 6000;
      function startLoop(dr) {
        cancelAnimationFrame(dr._anim);
        if (dr.path.length < 2) return;
        const from = dr.path[dr.path.length-2];
        const to   = dr.path[dr.path.length-1];
        const step = ts => {
          if (dr.dragging) { dr._anim = requestAnimationFrame(step); return; }
          const phase = (ts % LOOP_MS) / LOOP_MS;
          const p     = 0.5 - 0.5 * Math.cos(2 * Math.PI * phase);   // –∑–≥–ª–∞–¥–∂–µ–Ω–∞ —Å–∏–Ω—É—Å–æ—ó–¥–∞
          const lat   = from.lat + (to.lat - from.lat) * p;
          const lng   = from.lng + (to.lng - from.lng) * p;
          dr.marker.setLatLng([lat,lng]);
          dr._anim = requestAnimationFrame(step);
        };
        dr._anim = requestAnimationFrame(step);
      }

      /* ‚îÄ‚îÄ 5. –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –ø–æ –∫–∞—Ä—Ç—ñ ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –¥—Ä–æ–Ω–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      window.map.on('click', e => {
        if (!selected || !(selected in icons)) return;

        // –±–∞–∑–æ–≤—ñ –æ–±‚Äô—î–∫—Ç–∏ ‚ñ∏ –º–∞—Ä–∫–µ—Ä, –ª—ñ–Ω—ñ—ó, —Å—Ç—Ä—ñ–ª–∫–∞
        const marker = L.marker(e.latlng, {
          icon: icons[selected],
          draggable: true,
          rotationOrigin: 'center'
        }).addTo(window.map);

        const shadow = L.polyline([], { color:'#fff', weight:4, opacity:0.5 }).addTo(window.map);
        const line   = L.polyline([], { color:'#000', weight:2 }).addTo(window.map);

        const idx = window.drones.length;
        const dr = {
          marker,
          shadow,
          line,
          arrow: null,
          rotOffset: rotOffset[selected] ?? rotOffset.default,
          path: [ e.latlng ],   // –º–∞—Å–∏–≤ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ç–æ—á–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É
          dragging:false,
          _anim:0
        };
        window.drones.push(dr);

        /* ‚îÄ drag events ‚îÄ */
        let startPos;
        marker.on('dragstart', () => { dr.dragging = true; startPos = marker.getLatLng(); });
        marker.on('dragend',   () => {
          dr.dragging = false;
          dr.path.push(marker.getLatLng());          // –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—É —Ç–æ—á–∫—É
          if (dr.path.length > 7) dr.path.shift();   // —Ç—Ä–∏–º–∞—î–º–æ –ª–∏—à–µ 7 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö

          // –æ–Ω–æ–≤–ª—é—î–º–æ –ª—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É
          shadow.setLatLngs(dr.path);
          line.setLatLngs(dr.path);

          // —Å—Ç—Ä—ñ–ª–∫–∞ –Ω–∞–ø—Ä—è–º–∫—É –ø–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É
          const from = dr.path[dr.path.length-2];
          const to   = dr.path[dr.path.length-1];
          if (dr.arrow) window.map.removeLayer(dr.arrow);
          dr.arrow = L.marker(from, {
            icon: arrowIcon,
            rotationAngle: bearing(from, to) - 90,
            interactive:false
          }).addTo(window.map);

          // –∞–Ω—ñ–º–∞—Ü—ñ—è –≤—ñ–¥ –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Ç–æ—á–∫–∏ –¥–æ –Ω–æ–≤–æ—ó
          startLoop(dr);
        });

        /* ‚îÄ –∑–≤–∏—á–∞–π–Ω–∏–π popup ‚îÄ */
        marker.bindPopup(`
          <b>${selected.toUpperCase()}</b><br>
          –ö—É—Ä—Å: <input id="h_${idx}" type="number" min="0" max="359" value="0" style="width:60px">
          <button onclick="setHeading(${idx}, document.getElementById('h_${idx}').value)">OK</button><br>
          <button onclick="removeDrone(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        `).openPopup();
      });
    }); // DOMContentLoaded
  </script>

</body>
</html>
